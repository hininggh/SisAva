{% extends 'base.html' %}
{% load mural_tags %}
{% load static %}
{% block title %}Detalhes do Curso - Relator{% endblock %}

{% block content %}
<style>
  .minimizable {
    border: 1px solid #ccc;
    padding: 10px;
    margin-bottom: 10px;
  }
  .minimizable h2 {
    margin-top: 0;
    cursor: pointer;
  }
  .minimizable-content {
    margin-top: 10px;
  }

  .indicador-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    padding-bottom: 10px;
    margin-bottom: 2px;
    border-bottom: 1px solid #ccc;
  }
  .indicador-info:last-child {
    border-bottom: none;
  }

  .btn-container {
    display: flex;
    gap: 10px;
    justify-content: flex-start; /* Alinha os botões à esquerda */
  }


  /* Estilos para as mensagens do mural */
  .mural-message {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      background-color: #f9f9f9;
      position: relative;
  }

  .mural-message h3 {
      margin: 0;
      font-size: 1.1em;
      font-weight: bold;
  }

  .mural-message p {
      margin: 5px 0;
      font-size: 1em;
  }

  .mural-message .message-actions {
      position: absolute;
      top: 10px;
      right: 10px;
  }

  .mural-message .message-actions button {
      margin-left: 5px;
      font-size: 0.9em;
  }

</style>

<div class="container mt-4">
    <div class="minimizable">
        <h2>{{ curso.nome }}</h2>
        <div class="minimizable-content">
            <p><strong>Inscrição:</strong> {{ curso.inscricao }}</p>
            <p><strong>Detalhes:</strong> {{ curso.detalhes }}</p>
            {% if curso.privilegios %}
                <p>Edição do curso, capa e informações complementares aos liberada demais relatores</strong> </p>
            {% endif %}
            <!-- Alinhar os botões à esquerda -->
            <div class="btn-container mt-4">
                {% if request.user == curso.criador or privilegios %}
                    <a href="{% url 'editar_curso' curso.id %}" class="btn btn-primary">Editar Curso</a>
                {% endif %}
                <a href="{% url 'gerar_relatorio_geral' curso.id %}" class="btn btn-secondary">Gerar Relatório Geral</a>
            </div>

            <!-- Seção de Manipulação de Capa -->
            {% if usuario_autorizado %}
                <div style="margin-top: 20px;">
                    {% if curso.capa %}
                        <p><strong>Capa da Avaliação:</strong> {{ curso.capa.name }}</p>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <a href="{% url 'baixar_capa' curso.id %}">
                                <img class="icon" src="{% static 'icons/download.png' %}" alt="Baixar Capa" style="width: 20px;">
                            </a>
                            <a href="#" onclick="confirmarSubstituirCapa()">
                                <img class="icon" src="{% static 'icons/substituir.png' %}" alt="Substituir Capa" style="width: 20px;">
                            </a>
                            <form method="post" action="{% url 'deletar_capa' curso.id %}" class="inline-form" style="margin: 0;" onsubmit="return confirmarDeletarCapa();">
                                {% csrf_token %}
                                <button type="submit" style="border: none; background: none; padding: 0;">
                                    <img class="icon" src="{% static 'icons/cancelar.png' %}" alt="Deletar Capa" style="width: 20px;">
                                </button>
                            </form>
                        </div>
                    {% else %}
                        <p><strong>Capa da Avaliação:</strong> Nenhuma capa enviada</p>
                        <a href="#" onclick="document.getElementById('file-upload-capa').click();">
                            <img class="icon" src="{% static 'icons/envio.png' %}" alt="Enviar Capa" style="width: 20px;">
                        </a>
                    {% endif %}

                    <!-- Formulário de envio/substituição de capa -->
                    <form id="enviar-capa-form" method="post" enctype="multipart/form-data" action="{% url 'enviar_ou_substituir_capa' curso.id %}">
                        {% csrf_token %}
                        <input type="file" name="capa" id="file-upload-capa" style="display: none;" onchange="document.getElementById('enviar-capa-form').submit();">
                    </form>
                </div>
            {% endif %}
        </div>
    </div>
</div>


    <!-- Mural -->
    <div class="mural-section">
        <div class="minimizable">
            <h2>Mural de Mensagens</h2>
            <div class="minimizable-content" style="display: none;">
                <button class="btn btn-secondary btn-sm" onclick="toggleMessageBox()">Abrir Caixa de Mensagem</button>
                <form id="form-postar-mensagem" onsubmit="postarMensagem(event)" style="display: none;">
                    {% csrf_token %}
                    <textarea name="mensagem" class="form-control" placeholder="Escreva sua mensagem"></textarea>
                    <!-- O botão de envio terá seu texto atualizado pelo JavaScript -->
                    <button type="submit" id="submit-button" class="btn btn-primary mt-2">Postar nova mensagem</button>
                </form>

                <!-- Container das mensagens do mural -->
                <div id="mural-messages" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Indicadores do Curso -->
    <div class="minimizable">
        <h3>Indicadores por Dimensão</h3>
        {% for dimensao, dados in indicadores_por_dimensao.items %}
            <div class="minimizable-content">
                <h2>{{ dimensao }}</h2>
                <ul>
                    <!-- Iterando pelos IndicadorMan de cada IndicadorInfo corretamente -->
                    {% for indicador in dados.indicadores_man %}
                        <li class="indicador-info">
                            <!-- Nome do Indicador -->
                            <a href="{% url 'visualizar_indicador' curso.id indicador.id %}" title="{{ indicador.indicador_info.mensagem_aviso }}" style="flex-grow: 1;">
                                {{ indicador.indicador_info.nome }}
                            </a>

                            <!-- Conceito ou NSA e Ícones, alinhados à direita -->
                            <div style="display: flex; align-items: center; gap: 10px;">
                                {% if indicador.NSA %}
                                    <span style="font-weight: bold; margin-right: 10px;">- NSA -</span>
                                {% elif indicador.nivel_suposto %}
                                    <span style="font-weight: bold; margin-right: 10px;">Conceito {{ indicador.nivel_suposto }}</span>
                                {% endif %}

                                <!-- Ícones de Relatório -->
                                {% if not indicador.NSA %}
                                    {% if indicador.conteudo %}
                                        <a href="{% url 'baixar_relatorio' curso.id indicador.id %}">
                                            <img class="icon" src="{% static 'icons/download.png' %}" alt="Baixar" style="width: 20px;">
                                        </a>
                                        <a href="#" onclick="confirmarSubstituirRelatorio('{{ indicador.indicador_info.nome }}', {{ indicador.id }})">
                                            <img class="icon" src="{% static 'icons/substituir.png' %}" alt="Substituir" style="width: 20px;">
                                        </a>
                                        <form method="post" action="{% url 'deletar_relatorio' curso.id indicador.id %}?origem=curso" class="inline-form" style="margin: 0;" onsubmit="return confirmarDeletarRelatorio('{{ indicador.indicador_info.nome }}');">
                                            {% csrf_token %}
                                            <button type="submit" style="border: none; background: none; padding: 0;">
                                                <img class="icon" src="{% static 'icons/cancelar.png' %}" alt="Deletar" style="width: 20px;">
                                            </button>
                                        </form>
                                    {% else %}
                                        <a href="#" onclick="document.getElementById('file-upload-{{ indicador.id }}').click();">
                                            <img class="icon" src="{% static 'icons/envio.png' %}" alt="Enviar Relatório" style="width: 20px;">
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </div>

                            <!-- Formulário de envio de relatório -->
                            <form id="enviar-relatorio-form-{{ indicador.id }}" method="post" enctype="multipart/form-data" action="{% url 'enviar_ou_substituir_relatorio' curso.id indicador.id %}?origem=curso">
                                {% csrf_token %}
                                <input type="file" name="conteudo" id="file-upload-{{ indicador.id }}" style="display: none;" onchange="document.getElementById('enviar-relatorio-form-{{ indicador.id }}').submit();">
                            </form>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        {% endfor %}
    </div>

    <!-- Informações Complementares -->
    <div class="minimizable">
        <h2>Informações Complementares</h2>
        <div class="minimizable-content">
            <div id="informacoes-complementares-content">
                <p>{{ curso.informacoes_complementares|default:"Sem informações complementares" }}</p>
            </div>

            {% if request.user == curso.criador or privilegios %}
                <button id="editar-informacoes-btn" class="btn btn-primary btn-sm mt-2" onclick="toggleEditInformacoes()">Editar</button>
            {% endif %}

            <!-- Formulário de edição das Informações Complementares -->
            <form id="form-editar-informacoes" method="post" action="{% url 'editar_informacoes_complementares' curso.id %}" style="display: none;">
                {% csrf_token %}
                <textarea name="informacoes_complementares" class="form-control mt-2">{{ curso.informacoes_complementares }}</textarea>
                <button type="submit" class="btn btn-success btn-sm mt-2">Salvar</button>
                <button type="button" class="btn btn-secondary btn-sm mt-2" onclick="toggleEditInformacoes()">Cancelar</button>
            </form>
        </div>
    </div>
</div>

<script>
    // ------------------------------MURAL-------------------------

    // Função para exibir a caixa de mensagem do usuário logado
function toggleMessageBox() {
    const form = document.getElementById("form-postar-mensagem");
    form.style.display = form.style.display === "none" ? "block" : "none";
}

// Função para postar ou substituir uma mensagem
function postarMensagem(event) {
    event.preventDefault();

    const mensagem = document.querySelector('#form-postar-mensagem textarea[name="mensagem"]').value;

    fetch("{% url 'postar_mensagem' curso.id %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `mensagem=${encodeURIComponent(mensagem)}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.status && data.status.includes("sucesso")) {
            atualizarMural();
            document.querySelector('#form-postar-mensagem textarea[name="mensagem"]').value = ""; // Limpa o campo
        } else {
            alert(data.status || "Erro ao postar a mensagem.");
        }
    })
    .catch(error => console.error("Erro ao postar mensagem:", error));
}

// Função para atualizar a lista de mensagens do mural
function atualizarMural() {
    fetch("{% url 'atualizar_mural' curso.id %}", {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
        const muralContainer = document.getElementById("mural-messages");
        muralContainer.innerHTML = '';  // Limpa a lista atual

        // Converte o ID do usuário para um inteiro
        const userId = parseInt("{{ request.user.id }}");

        let mensagemDoUsuario = null;

        data.mensagens.forEach(mensagem => {
            const mensagemElement = document.createElement("div");
            mensagemElement.classList.add("mural-message");

            // Verifica se a mensagem pertence ao usuário atual
            if (mensagem.pode_editar) {
                mensagemDoUsuario = mensagem;
            }

            // Adiciona o botão "Excluir" se a mensagem for do usuário
            let acoesHtml = "";
            if (mensagem.pode_editar) {
                acoesHtml = `
                    <button onclick="apagarMensagem(${mensagem.id})" class="btn btn-danger btn-sm mt-2">Excluir</button>
                `;
            }

            mensagemElement.innerHTML = `
                <h3>${mensagem.autor}</h3>
                <p>${mensagem.mensagem}</p>
                ${acoesHtml}
            `;

            muralContainer.appendChild(mensagemElement);
        });

        // Atualiza o texto do botão dependendo se existe uma mensagem do usuário
        const submitButton = document.getElementById("submit-button");
        if (mensagemDoUsuario) {
            submitButton.textContent = "Substituir sua mensagem";
        } else {
            submitButton.textContent = "Postar nova mensagem";
        }
    })
    .catch(error => console.error("Erro ao atualizar mural:", error));
}

// Função para apagar uma mensagem
function apagarMensagem(mensagemId) {
    if (confirm("Tem certeza que deseja excluir esta mensagem?")) {
        fetch(`{% url 'apagar_mensagem' 0 %}`.replace('/0/', `/${mensagemId}/`), {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status && data.status.includes("sucesso")) {
                atualizarMural();
            } else {
                alert(data.status || "Erro ao excluir a mensagem.");
            }
        })
        .catch(error => console.error("Erro ao excluir mensagem:", error));
    }
}

// Carrega o mural inicial ao abrir a página
document.addEventListener("DOMContentLoaded", function() {
    atualizarMural();
});



  // ---------------------MINIMIZAÇÃO----------------

    //minimizar
    document.addEventListener("DOMContentLoaded", function() {
        const minimizables = document.querySelectorAll('.minimizable h2');

        minimizables.forEach(header => {
            header.addEventListener('click', function() {
                const content = this.nextElementSibling; // Encontra o próximo elemento para expandir/colapsar
                if (content) {
                    content.style.display = content.style.display === "none" ? "block" : "none";
                }
            });
        });
    });

// ------------------------------RELAToRIO-------------------------

    // Submete o formulário automaticamente após selecionar o arquivo
    document.getElementById("file-upload").onchange = function() {
        document.getElementById("enviar-relatorio-form").submit();
    };

    // Confirmação para substituição de relatório
    function confirmarSubstituirRelatorio(nomeIndicador, indicadorId) {
        if (confirm(`O relatório já existente será apagado para salvar o novo. Deseja continuar com o indicador ${nomeIndicador}?`)) {
            document.getElementById(`file-upload-${indicadorId}`).click();
        }
    }

    // Confirmação para deletar relatório
    function confirmarDeletarRelatorio(nomeIndicador) {
        return confirm(`Você realmente deseja apagar o relatório do indicador ${nomeIndicador}?`);
    }


// ------------------------------CAPA-------------------------

      // Função de confirmação para substituição da capa


    // Função de confirmação para exclusão da capa
    function confirmarDeletarCapa() {
        return confirm("Você está apagando a CAPA da avaliação do curso. Deseja continuar?");
    }

    function confirmarSubstituirCapa() {
        if (confirm("Substituir apagará a capa atual da Avaliação. Deseja continuar?")) {
            document.getElementById('file-upload-capa').click();
        }
    }

    function confirmarDeletarCapa() {
        return confirm("Você está apagando a CAPA da avaliação do curso {{ curso.nome }}. Deseja continuar?");
    }



</script>

{% endblock %}
