{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Botão Voltar ao Curso -->
<div style="margin-bottom: 20px;">
    <a href="{% url 'visualizar_curso' curso.id %}" class="btn btn-secondary">Voltar ao Curso</a>
</div>

<h1>{{ indicador_man.indicador_info.nome }}</h1>
{% if indicador_man.NSA %}
    <p>-NSA-</p>
{% endif %}
<p>{{ indicador_man.indicador_info.mensagem_aviso }}</p>

<!-- Botão para Aplicar ou Remover NSA -->
<!-- Formulário para Aplicar/Remover NSA -->
<div style="display: inline-block; margin-right: 20px;">
    <form method="post" action="{% if indicador_man.NSA %}{% url 'remover_nsa' curso.id indicador_man.id %}{% else %}{% url 'aplicar_nsa' curso.id indicador_man.id %}{% endif %}" class="inline-form" onsubmit="return confirmarAplicarNSA('{{ indicador_man.indicador_info.nome }}', {{ has_relatorio|yesno:'true,false' }}, {{ nivel_suposto_vazio|yesno:'false,true' }})">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">
            {% if indicador_man.NSA %}
                Desaplicar NSA
            {% else %}
                Aplicar NSA
            {% endif %}
        </button>
    </form>
</div>


<!-- Seleção de Nível Suposto e Opções de Relatório -->
{% if not indicador_man.NSA %}
    <div style="display: inline-block;">
    <form method="post" action="{% url 'aplicar_nivel_suposto' curso.id indicador_man.id %}" class="inline-form">
            {% csrf_token %}
            {{ nivel_suposto_form.nivel_suposto }}
            <button type="submit" class="btn btn-primary">Salvar Nível Suposto</button>
        </form>
    </div>

    <div style="margin-top: 20px;">
        {% if indicador_man.conteudo %}
            <p><strong>Relatório:</strong> {{ indicador_man.conteudo.name }}</p>
            <p><strong>Data de Envio:</strong> {{ indicador_man.data_envio }}</p>
            <p><strong>Usuário que enviou:</strong> {{ indicador_man.usuario_relatorio.nome }}</p>

            <div style="display: flex; align-items: center; gap: 10px;">
                <a href="{% url 'baixar_relatorio' curso.id indicador_man.id %}">
                    <img class="icon" src="{% static 'icons/download.png' %}" alt="Baixar" style="width: 20px;">
                </a>

                <a href="#" onclick="confirmarSubstituirRelatorio()">
                    <img class="icon" src="{% static 'icons/substituir.png' %}" alt="Substituir" style="width: 20px;">
                </a>

                <form method="post" action="{% url 'deletar_relatorio' curso.id indicador_man.id %}" class="inline-form" style="margin: 0;" onsubmit="return confirmarDeletarRelatorio('{{ indicador_man.indicador_info.nome }}');">
                    {% csrf_token %}
                    <button type="submit" style="border: none; background: none; padding: 0;">
                        <img class="icon" src="{% static 'icons/cancelar.png' %}" alt="Deletar" style="width: 20px;">
                    </button>
                </form>
            </div>
        {% else %}
            <p><strong>Relatório:</strong> Nenhum envio</p>
            <a href="#" onclick="document.getElementById('file-upload').click();">
                <img class="icon" src="{% static 'icons/envio.png' %}" alt="Enviar Relatório" style="width: 20px;">
            </a>
        {% endif %}

        <form id="enviar-relatorio-form" method="post" enctype="multipart/form-data" action="{% url 'enviar_ou_substituir_relatorio' curso.id indicador_man.id %}">
            {% csrf_token %}
            <input type="file" name="conteudo" id="file-upload" style="display: none;">
        </form>
    </div>
{% endif %}

<!-- Tabela de Conceitos -->
<h3>Tabela de Conceitos</h3>
<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
    <tr>
        <th style="border: 1px solid #000; padding: 8px; background-color: #f2f2f2;">Conceito</th>
        <th style="border: 1px solid #000; padding: 8px; background-color: #f2f2f2;">Critério de Análise</th>
    </tr>
    {% for conceito, criterio in tabela_conceitos.items %}
        <tr>
            <td style="border: 1px solid #000; padding: 8px; text-align: center;">{{ conceito }}</td>
            <td style="border: 1px solid #000; padding: 8px;">{{ criterio }}</td>
        </tr>
    {% endfor %}
</table>

<script>
    // Submete o formulário de upload de relatório automaticamente após selecionar o arquivo
    document.getElementById("file-upload").onchange = function() {
        document.getElementById("enviar-relatorio-form").submit();
    };

    // Confirmação para aplicar NSA, verificando se há relatório ou conceito
    function confirmarAplicarNSA(nomeIndicador, hasReport, nivelSupostoVazio) {
        if (hasReport || !nivelSupostoVazio) {
            return confirm(`Aplicar NSA apagará o relatório e/ou o conceito para o indicador ${nomeIndicador}. Deseja continuar?`);
        }
        return true;
    }

    // Confirmação para substituir relatório
    function confirmarSubstituirRelatorio() {
        if (confirm("O relatório já existente será apagado para salvar o novo. Deseja continuar?")) {
            document.getElementById("file-upload").click();
        }
    }


    function confirmarDeletarRelatorio(nomeIndicador) {
        return confirm(`Você deseja continuar com a exclusão do relatório do indicador ${nomeIndicador}?`);
    }

</script>
{% endblock %}
