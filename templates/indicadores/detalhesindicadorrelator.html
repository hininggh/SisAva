{% extends 'base.html' %}
{% load static %}

{% block content %}
<!-- Botão Voltar ao Curso -->
<div style="margin-bottom: 20px;">
    <a href="{% url 'visualizar_curso' curso.id %}" class="btn btn-secondary">Voltar ao Curso</a>
</div>

<h1>{{ indicador_man.indicador_info.nome }}</h1>
<p>{{ indicador_man.indicador_info.mensagem_aviso }}</p>

{% if indicador_man.NSA %}
    <p>-NSA-</p>
{% endif %}
<!-- Botão para Aplicar ou Remover NSA -->

<div style="display: inline-block; margin-right: 20px;">
<form method="post" action="{% if indicador_man.NSA %}{% url 'remover_nsa' curso.id indicador_man.id %}{% else %}{% url 'aplicar_nsa' curso.id indicador_man.id %}{% endif %}" class="inline-form" onsubmit="return confirmarAplicarNSA('{{ indicador_man.indicador_info.nome }}')">
        {% csrf_token %}
        <button type="submit" class="btn btn-primary">
            {% if indicador_man.NSA %}
                Desaplicar NSA
            {% else %}
                Aplicar NSA
            {% endif %}
        </button>
    </form>
</div>


<!-- Seleção de Nível Suposto e Opções de Relatório -->
{% if not indicador_man.NSA %}
    <div style="display: inline-block;">
    <form method="post" action="{% url 'aplicar_nivel_suposto' curso.id indicador_man.id %}" class="inline-form">
            {% csrf_token %}
            {{ nivel_suposto_form.nivel_suposto }}
            <button type="submit" class="btn btn-primary">Salvar Nível Suposto</button>
        </form>
    </div>
    <!-- Documento Compartilhado -->
    <div style="margin-top: 20px;">
        <h3>Relatório do Indicador</h3>
        {% if indicador_man.documento_tinymce %}
            <p><strong>Status:</strong> Documento presente</p>
            {% if indicador_man.em_edicao %}
                <p><strong>Em edição por:</strong> {{ indicador_man.usuario_editando.nome }}</p>
                <p><strong>Início da edição:</strong> {{ indicador_man.edicao_inicio }}</p>
            {% else %}
                <p><strong>Status de edição:</strong> Não está em edição</p>
            {% endif %}
        {% else %}
            <p><strong>Status:</strong> Nenhum documento presente</p>
        {% endif %}

        <!-- Botão para Editar ou Criar Documento -->
        <div style="margin-top: 10px;">
            {% if indicador_man.documento_tinymce and not indicador_man.em_edicao %}
                <a href="{% url 'gerenciar_documento_compartilhado' indicador_man.id %}" class="btn btn-primary">
                    Editar Documento Compartilhado
                </a>
            {% elif not indicador_man.documento_tinymce %}
                <a href="{% url 'gerenciar_documento_compartilhado' indicador_man.id %}" class="btn btn-success">
                    Criar Documento Compartilhado
                </a>
            {% else %}
                <button class="btn btn-secondary" disabled>
                    Documento em edição
                </button>
            {% endif %}
        </div>
    </div>


    <!-- Sessão oculta expansível para Relatórios -->
    <div style="margin-top: 20px;">
        <button class="btn btn-info" onclick="toggleRelatorios()">Exibir Documentos</button>
        <div id="relatorios-section" style="display: none; margin-top: 10px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <!-- Botão para baixar todos os PDFs -->
                <a href="{% url 'baixar_todos_pdfs' curso.id indicador_man.id %}" class="btn btn-primary">
                    Baixar Todos os PDFs
                </a>

                <form id="form-enviar-relatorio" method="POST" action="{% url 'enviar_ou_substituir_relatorio' curso.id indicador_man.id %}" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="relatorio_id" id="relatorio-id">
                    <input type="file" name="arquivo" id="file-upload" style="display: none;" onchange="document.getElementById('form-enviar-relatorio').submit();">
                </form>

                <!-- Botão para abrir seletor de arquivos -->
                <button class="btn btn-success" onclick="document.getElementById('file-upload').click();">
                    Acrescentar Relatório
                </button>
            </div>

            <!-- Tabela de relatórios -->
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px;">
                <tr>
                    <th style="border: 0.5px solid #000; padding: 5px; background-color: #f2f2f2;">Relator</th>
                    <th style="border: 0.5px solid #000; padding: 5px; background-color: #f2f2f2;">Data de Envio</th>
                    <th style="border: 0.5px solid #000; padding: 5px; background-color: #f2f2f2;">Arquivo</th>
                    <th style="border: 0.5px solid #000; padding: 5px; background-color: #f2f2f2;">Ações</th>
                </tr>
                {% for relatorio in relatorios_pdfs %}
                    <tr>
                        <td style="border: 0.5px solid #000; padding: 5px;">{{ relatorio.usuario_upload }}</td>
                        <td style="border: 0.5px solid #000; padding: 5px;">{{ relatorio.data_upload }}</td>
                        <td style="border: 0.5px solid #000; padding: 5px;">{{ relatorio.arquivo_nome }}</td>
                        <td style="border: 0.5px solid #000; padding: 5px; text-align: center;">
                            <!-- Ações alinhadas -->
                            <div style="display: flex; justify-content: center; gap: 10px;">
                                <!-- Ação de baixar -->
                                <a href="{% url 'baixar_relatorio_pdf' relatorio.id %}">
                                    <img class="icon" src="{% static 'icons/download.png' %}" alt="Baixar" style="width: 20px;">
                                </a>
                                <!-- Ação de substituir -->
                                <a href="#" onclick="substituirRelatorio('{{ relatorio.id }}')">
                                    <img class="icon" src="{% static 'icons/substituir.png' %}" alt="Substituir" style="width: 20px;">
                                </a>
                                <!-- Ação de deletar -->
                                <form method="post" action="{% url 'deletar_relatorio_pdf' relatorio.id %}" class="inline-form" style="margin: 0;" onsubmit="return confirmarDeletarRelatorio('{{ indicador_man.indicador_info.nome }}');">
                                    {% csrf_token %}
                                    <button type="submit" style="border: none; background: none; padding: 0;">
                                        <img class="icon" src="{% static 'icons/cancelar.png' %}" alt="Deletar" style="width: 20px;">
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </table>
        </div>
    </div>
{% endif %}
<p> </p>
<!-- Tabela de Conceitos -->
<h3>Tabela de Conceitos</h3>
<table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
    <tr>
        <th style="border: 1px solid #000; padding: 8px; background-color: #f2f2f2; text-align: center;">Conceito</th>
        <th style="border: 1px solid #000; padding: 8px; background-color: #f2f2f2; text-align: center;">Critério de Análise</th>
    </tr>
    {% for conceito, criterio in tabela_conceitos.items %}
        <tr>
            <td style="border: 1px solid #000; padding: 8px; text-align: center;">{{ conceito }}</td>
            <td style="border: 1px solid #000; padding: 8px;">{{ criterio }}</td>
        </tr>
    {% endfor %}
</table>

<script>
    const NSA = {{ indicador_man.NSA|yesno:"true,false" }};  // Isso resultará em true ou false
    const nivelSuposto = {{ indicador_man.nivel_suposto|default:'null' }};  // Exibe o nível suposto ou null se não estiver definido
    const hasRelatorio = {{ relatorios_pdfs|yesno:"true,false" }};  // Isso resultará em true ou false

    // Submete o formulário de upload de relatório automaticamente após selecionar o arquivo
    document.getElementById("file-upload").onchange = function () {
        document.getElementById("form-enviar-relatorio").submit();
    };

        // Confirmação para aplicar NSA, verificando se há relatório ou conceito
    function confirmarAplicarNSA(nomeIndicador) {
        // Verifica se NSA não está aplicado
        if (!NSA) {
            // Só exibe a mensagem se houver relatório ou o nível suposto não for nulo
            if (hasRelatorio || nivelSuposto !== null) {
                return confirm(`Aplicar NSA apagará o relatório e/ou o conceito para o indicador ${nomeIndicador}. Deseja continuar?`);
            }
        }
        return true;
    }


    // Confirmação para substituir relatório
    function substituirRelatorio(relatorioId) {
        if (confirm("O relatório existente será substituído. Deseja continuar?")) {
            document.getElementById('relatorio-id').value = relatorioId;
            document.getElementById('file-upload').click();
        }
    }


    function confirmarDeletarRelatorio(nomeIndicador) {
        return confirm(`Você deseja continuar com a exclusão do relatório do indicador ${nomeIndicador}?`);
    }

    function toggleRelatorios() {
        const section = document.getElementById('relatorios-section');
        section.style.display = section.style.display === 'none' ? 'block' : 'none';
    }


</script>
{% endblock %}
